name: Build Telegram Bot APK

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 100
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          git \
          zip \
          unzip \
          openjdk-17-jdk \
          python3-pip \
          python3-venv \
          autoconf \
          automake \
          libtool \
          pkg-config \
          libffi-dev \
          libssl-dev \
          libjpeg-dev \
          zlib1g-dev
        
    - name: ğŸ”§ Install Buildozer
      run: |
        pip install --upgrade pip
        pip install buildozer cython==0.29.36
        
    - name: ğŸ“ Accept Android licenses
      run: |
        mkdir -p ~/.android
        echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > ~/.android/licenses/android-sdk-license
        echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> ~/.android/licenses/android-sdk-license
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" >> ~/.android/licenses/android-sdk-license
        
    - name: ğŸ§¹ Clean previous builds
      run: |
        rm -rf .buildozer 2>/dev/null || true
        rm -rf bin 2>/dev/null || true
        
    - name: ğŸ—ï¸ Build APK
      run: |
        echo "=== Starting Build Process ==="
        echo "Time: $(date)"
        
        # Ù…Ø±Ø­Ù„Ù‡ 1: Ø¯Ø§Ù†Ù„ÙˆØ¯ SDK
        echo "Step 1: Downloading Android SDK..."
        timeout 1500 buildozer android update 2>&1 | tee update.log || echo "Update phase completed"
        
        # Ù…Ø±Ø­Ù„Ù‡ 2: Ø³Ø§Ø®Øª APK
        echo "Step 2: Building APK..."
        buildozer -v android debug 2>&1 | tee build.log
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ù†ØªÛŒØ¬Ù‡
        if find bin/ -name "*.apk" 2>/dev/null | grep -q .; then
          echo "âœ…âœ…âœ… BUILD SUCCESSFUL! âœ…âœ…âœ…"
          APK_FILE=$(find bin/ -name "*.apk" | head -1)
          echo "APK: $APK_FILE"
          ls -lh "$APK_FILE"
          echo "Size: $(du -h "$APK_FILE" | cut -f1)"
        else
          echo "âŒâŒâŒ BUILD FAILED âŒâŒâŒ"
          echo "=== Error Summary ==="
          grep -i "error\|failed\|exception\|autoreconf\|autoconf" build.log | head -20
          echo "=== Last 50 lines ==="
          tail -50 build.log
          exit 1
        fi
        
    - name: ğŸ“¤ Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: telegram-bot-apk
        path: bin/*.apk
        retention-days: 90
        
    - name: ğŸ“‹ Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build.log
          update.log
        retention-days: 30
