name: Build Telegram Bot APK

on:
  workflow_dispatch:  # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  BUILD_PATH: ${{ github.workspace }}
  CACHE_KEY: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec', 'requirements.txt') }}

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 120  # Ø§ÙØ²Ø§ÛŒØ´ Ø²Ù…Ø§Ù† Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ SDK
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        
    - name: ðŸ Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ðŸ“¦ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git \
          wget \
          curl \
          zip \
          unzip \
          openjdk-17-jdk \
          python3-pip \
          python3-venv \
          python3-setuptools \
          libffi-dev \
          libssl-dev \
          libjpeg-dev \
          zlib1g-dev \
          libncurses5-dev \
          libsqlite3-dev \
          libreadline-dev \
          libbz2-dev
        
    - name: ðŸ”§ Install Buildozer and dependencies
      run: |
        python -m pip install --upgrade pip wheel setuptools
        pip install buildozer cython==0.29.36 virtualenv
        
    - name: ðŸ“ Accept Android SDK licenses
      run: |
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
        
        # Accept all necessary licenses
        echo -e "8933bad161af4178b1185d1a37fbf41ea5269c55\nd56f5187479451eabf01fb78af6dfcb131a6481e" > ~/.android/licenses/android-sdk-license
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" >> ~/.android/licenses/android-sdk-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" >> ~/.android/licenses/android-sdk-license
        
        echo "Android SDK licenses accepted"
        
    - name: ðŸ—‘ï¸ Clean previous builds
      run: |
        rm -rf .buildozer 2>/dev/null || true
        rm -rf bin 2>/dev/null || true
        rm -f build.log 2>/dev/null || true
        
    - name: ðŸ—ï¸ Build APK (Debug)
      run: |
        echo "=== Starting APK Build Process ==="
        echo "Date: $(date)"
        echo "Python: $(python --version)"
        echo "Buildozer: $(buildozer --version 2>/dev/null || echo 'Not found')"
        
        # Create minimal buildozer.spec if not exists
        if [ ! -f buildozer.spec ]; then
          echo "Creating minimal buildozer.spec..."
          cat > buildozer.spec << 'EOF'
[app]
title = Telegram Bot Pro
package.name = telegrambotpro
package.domain = com.telegram
version = 1.0.0
version.code = 1
source.dir = .
source.main = main.py
requirements = python3, kivy==2.1.0, requests
orientation = portrait
fullscreen = 0
android.permissions = INTERNET, WRITE_EXTERNAL_STORAGE, READ_EXTERNAL_STORAGE
android.minapi = 21
android.targetapi = 33
android.archs = arm64-v8a
p4a.bootstrap = sdl2
android.accept_sdk_license = True
[buildozer]
log_level = 2
EOF
        fi
        
        # Display buildozer.spec content
        echo "=== buildozer.spec ==="
        cat buildozer.spec
        echo "====================="
        
        # First update to download SDK
        echo "Step 1: Downloading Android SDK (may take 10-15 minutes)..."
        timeout 1200 buildozer android update 2>&1 | tee update.log || echo "Update completed or timed out"
        
        # Check if update was successful
        if grep -q "error\|Error\|ERROR\|failed\|Failed\|FAILED" update.log; then
          echo "âš ï¸ Update had some errors, but continuing..."
        fi
        
        # Build APK
        echo "Step 2: Building APK (may take 20-30 minutes)..."
        timeout 1800 buildozer -v android debug 2>&1 | tee build.log
        
        # Check build result
        if [ -f "bin/"*.apk ] || [ -f "bin/app-debug.apk" ] || ls bin/*.apk 1> /dev/null 2>&1; then
          echo "âœ…âœ…âœ… BUILD SUCCESSFUL! âœ…âœ…âœ…"
          APK_FILE=$(find bin/ -name "*.apk" -type f | head -1)
          echo "APK File: $APK_FILE"
          ls -lh "$APK_FILE"
          echo "APK Size: $(du -h "$APK_FILE" | cut -f1)"
        else
          echo "âŒâŒâŒ BUILD FAILED! âŒâŒâŒ"
          echo "=== Last 100 lines of build.log ==="
          tail -100 build.log
          echo "=== Checking for errors ==="
          grep -i -A 5 -B 5 "error\|failed\|exception\|traceback\|ERROR\|FAILED" build.log | head -50
          exit 1
        fi
        
    - name: ðŸ“¤ Upload APK artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: telegram-bot-apk
        path: |
          bin/*.apk
          bin/
        retention-days: 90
        if-no-files-found: error
        
    - name: ðŸ“‹ Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build.log
          update.log
        retention-days: 30
        if-no-files-found: warn
        
    - name: ðŸ“Š Build Summary
      if: always()
      run: |
        echo "=== Build Summary ==="
        echo "Workflow: ${{ github.workflow }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "Repository: ${{ github.repository }}"
        echo "Commit: ${{ github.sha }}"
        
        if [ -f "build.log" ]; then
          BUILD_TIME=$(grep -i "real" build.log | tail -1 || echo "Unknown")
          echo "Build Time: $BUILD_TIME"
        fi
        
        if find bin/ -name "*.apk" 2>/dev/null | grep -q .; then
          APK_FILE=$(find bin/ -name "*.apk" | head -1)
          APK_SIZE=$(du -h "$APK_FILE" | cut -f1)
          echo "APK Created: âœ“"
          echo "APK Size: $APK_SIZE"
          echo "APK Path: $APK_FILE"
        else
          echo "APK Created: âœ—"
        fi
