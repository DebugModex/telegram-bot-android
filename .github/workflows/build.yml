name: Build APK

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create spec file
      run: |
        echo "[app]" > buildozer.spec
        echo "title = Telegram Bot" >> buildozer.spec
        echo "package.name = telegrambot" >> buildozer.spec
        echo "package.domain = com.example" >> buildozer.spec
        echo "version = 1.0.0" >> buildozer.spec
        echo "version.code = 1" >> buildozer.spec
        echo "source.dir = ." >> buildozer.spec
        echo "source.main = main.py" >> buildozer.spec
        echo "requirements = python3, kivy==2.1.0, requests" >> buildozer.spec
        echo "orientation = portrait" >> buildozer.spec
        echo "fullscreen = 0" >> buildozer.spec
        echo "android.permissions = INTERNET" >> buildozer.spec
        echo "android.minapi = 21" >> buildozer.spec
        echo "android.targetapi = 33" >> buildozer.spec
        echo "android.archs = arm64-v8a" >> buildozer.spec
        echo "p4a.bootstrap = sdl2" >> buildozer.spec
        echo "android.accept_sdk_license = True" >> buildozer.spec
        echo "" >> buildozer.spec
        echo "[buildozer]" >> buildozer.spec
        echo "log_level = 1" >> buildozer.spec
        echo "warn_on_root = 0" >> buildozer.spec
        
    - name: Build with Docker
      run: |
        docker run --rm -v $(pwd):/src kivy/buildozer android debug
          
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: telegram-app
        path: bin/*.apk
