name: Build Telegram Bot APK

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create buildozer.spec
      run: |
        cat > buildozer.spec << 'EOF'
[app]
title = Telegram Account Creator
package.name = telegramaccountcreator
package.domain = com.telegram.bot
version = 1.0.0
version.code = 1
source.dir = .
source.main = main.py
requirements = python3, kivy==2.1.0, requests
orientation = portrait
fullscreen = 0
android.permissions = INTERNET, WRITE_EXTERNAL_STORAGE, READ_EXTERNAL_STORAGE
android.minapi = 21
android.targetapi = 33
android.archs = arm64-v8a
p4a.bootstrap = sdl2
android.accept_sdk_license = True
android.allow_backup = True
android.usesCleartextTraffic = True

[buildozer]
log_level = 1
warn_on_root = 0
EOF
        
    - name: Build with Docker
      run: |
        docker run --rm \
          -v "$(pwd)":/src \
          -v "$(pwd)/.buildozer":/root/.buildozer \
          kivy/buildozer bash -c "cd /src && buildozer android debug"
          
    - name: Check result
      run: |
        if find bin/ -name "*.apk" 2>/dev/null | grep -q .; then
          echo "✅ BUILD SUCCESSFUL!"
          APK_FILE=$(find bin/ -name "*.apk" | head -1)
          echo "APK: $APK_FILE"
          ls -lh "$APK_FILE"
        else
          echo "❌ BUILD FAILED"
          exit 1
        fi
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: telegram-bot-apk
        path: bin/*.apk
